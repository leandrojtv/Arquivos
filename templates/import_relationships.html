{% extends "base.html" %}
{% block title %}Importar relacionamentos{% endblock %}
{% block content %}
<section class="form-section">
  <div class="section-header">
    <div>
      <p class="eyebrow">Importa√ß√£o guiada</p>
      <h2>Vincular bases a gestores</h2>
      <p class="subtitle">Fluxo em tr√™s etapas para mapear as colunas e atualizar rapidamente os v√≠nculos entre bases e gestores j√° cadastrados.</p>
    </div>
    <div class="pill">Relacionamentos</div>
  </div>

  {% if step == 'upload' %}
  <div class="wizard">
    <div class="wizard-step active">1. Arquivo</div>
    <div class="wizard-step">2. Mapeamento</div>
    <div class="wizard-step">3. Atualiza√ß√£o</div>
  </div>
  <form action="{{ url_for('import_relationships_flow', step='upload') }}" method="post" enctype="multipart/form-data" class="card">
    <label for="file">Arquivo (CSV ou XLSX)</label>
    <input type="file" name="file" id="file" accept=".csv,.xlsx,.xls" required />

    <label for="delimiter">Delimitador (para CSV)</label>
    <input type="text" name="delimiter" id="delimiter" value=";" maxlength="3" />
    <p class="form-helper">Usado apenas em CSV. Para XLSX √© ignorado.</p>

    <div class="actions-inline">
      <button type="submit" class="button"><span class="icon">‚¨ÜÔ∏è</span><span>Continuar</span></button>
      <a class="button ghost" href="{{ url_for('import_records') }}"><span class="icon">‚Ü©</span><span>Voltar</span></a>
    </div>
  </form>
  {% elif step == 'mapear' %}
  <div class="wizard">
    <div class="wizard-step done">1. Arquivo</div>
    <div class="wizard-step active">2. Mapeamento</div>
    <div class="wizard-step">3. Atualiza√ß√£o</div>
  </div>
  <form action="{{ url_for('import_relationships_flow', step='mapear') }}" method="post" class="card">
    <p class="form-helper">Selecione de quais colunas vir√£o a base (obrigat√≥ria), o gestor titular (obrigat√≥rio) e, se desejar, os substitutos.</p>
    <div class="grid-two">
      <div>
        <label for="map_base">Nome da base</label>
        <select name="map_base" id="map_base" required>
          <option value="">Selecione</option>
          {% for col in headers %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
        </select>
      </div>
      <div>
        <label for="map_gestor">Gestor titular (nome)</label>
        <select name="map_gestor" id="map_gestor" required>
          <option value="">Selecione</option>
          {% for col in headers %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
        </select>
      </div>
      <div>
        <label for="map_sub1">1¬∫ substituto (opcional)</label>
        <select name="map_sub1" id="map_sub1">
          <option value="">Ignorar</option>
          {% for col in headers %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
        </select>
      </div>
      <div>
        <label for="map_sub2">2¬∫ substituto (opcional)</label>
        <select name="map_sub2" id="map_sub2">
          <option value="">Ignorar</option>
          {% for col in headers %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
        </select>
      </div>
    </div>

    <div class="table-scroll">
      <table>
        <thead>
          <tr>{% for col in headers %}<th>{{ col }}</th>{% endfor %}</tr>
        </thead>
        <tbody>
          {% for row in preview %}
          <tr>{% for col in headers %}<td>{{ row.get(col, '') }}</td>{% endfor %}</tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="actions-inline">
      <a class="button ghost" href="{{ url_for('import_relationships_flow') }}"><span class="icon">‚Ü©</span><span>Voltar</span></a>
      <button type="submit" class="button"><span class="icon">‚û°Ô∏è</span><span>Avan√ßar</span></button>
    </div>
  </form>
  {% elif step == 'confirmar' %}
  <div class="wizard">
    <div class="wizard-step done">1. Arquivo</div>
    <div class="wizard-step done">2. Mapeamento</div>
    <div class="wizard-step active">3. Atualiza√ß√£o</div>
  </div>
  <div class="card">
    <p class="subtitle">Revise os v√≠nculos antes de atualizar. Apenas bases e gestores existentes ser√£o processados.</p>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Base</th>
            <th>Gestor</th>
            <th>1¬∫ Substituto</th>
            <th>2¬∫ Substituto</th>
          </tr>
        </thead>
        <tbody>
          {% for row in preview %}
          <tr>
            <td>{{ row.base }}</td>
            <td>{{ row.gestor }}</td>
            <td>{{ row.sub1 or '‚Äî' }}</td>
            <td>{{ row.sub2 or '‚Äî' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <p class="form-helper">Total de linhas encontradas: {{ total }}. Bases ou gestores inexistentes ser√£o ignorados e listados como erros.</p>
    <form action="{{ url_for('import_relationships_flow', step='executar') }}" method="post" class="actions-inline">
      <a class="button ghost" href="{{ url_for('import_relationships_flow', step='mapear') }}"><span class="icon">‚Ü©</span><span>Voltar</span></a>
      <button type="submit" class="button"><span class="icon">üîó</span><span>Atualizar v√≠nculos</span></button>
    </form>
  </div>
  {% elif step == 'resultado' %}
  <div class="wizard">
    <div class="wizard-step done">1. Arquivo</div>
    <div class="wizard-step done">2. Mapeamento</div>
    <div class="wizard-step done">3. Atualiza√ß√£o</div>
  </div>
  <div class="card">
    <p class="subtitle">Acompanhe o progresso da atualiza√ß√£o.</p>
    <div class="progress">
      <div class="progress-bar" style="width: {{ result.progress }}%"></div>
    </div>
    <div class="stats">
      <div class="stat"><strong>{{ result.imported }}</strong><span>Atualizados</span></div>
      <div class="stat"><strong>{{ result.total }}</strong><span>Total</span></div>
    </div>
    {% if result.errors and result.errors|length %}
    <div class="alert error">
      <p>Ocorreram avisos durante o processo:</p>
      <ul>
        {% for err in result.errors %}
        <li>{{ err }}</li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
    <div class="alert success">Atualiza√ß√£o finalizada sem erros.</div>
    {% endif %}
    <div class="actions-inline">
      <a class="button ghost" href="{{ url_for('import_relationships_flow') }}"><span class="icon">üîÅ</span><span>Rodar novamente</span></a>
      <a class="button" href="{{ url_for('list_bases') }}"><span class="icon">üìÑ</span><span>Ver bases</span></a>
    </div>
  </div>
  {% endif %}
</section>
{% endblock %}

{% extends "base.html" %}
{% block title %}Extra√ß√£o Teradata{% endblock %}
{% block content %}
<section class="form-section">
  <div class="section-header">
    <div>
      <p class="eyebrow">Fluxo em etapas</p>
      <h2>Teradata ¬∑ Metadados</h2>
      <p class="subtitle">Monte a conex√£o JDBC, teste rapidamente e aplique o cat√°logo diretamente nas bases com acompanhamento.</p>
    </div>
    <div class="pill">Teradata</div>
  </div>

  {% if step == 'config' %}
  <div class="wizard">
    <div class="wizard-step active">1. Conex√£o</div>
    <div class="wizard-step">2. Tipo</div>
    <div class="wizard-step">3. Agenda</div>
    <div class="wizard-step">4. Extra√ß√£o</div>
  </div>
  <form action="{{ url_for('extract_teradata', step='config') }}" method="post" class="card">
    <div class="grid-two">
      <div>
        <label for="host">Host / IP</label>
        <input type="text" name="host" id="host" value="{{ bucket.get('config', {}).get('host','') }}" placeholder="ex.: tera.company.local" />
      </div>
      <div>
        <label for="database_name">Nome do banco</label>
        <input type="text" name="database_name" id="database_name" value="{{ bucket.get('config', {}).get('database_name','') }}" placeholder="DBC" />
      </div>
      <div>
        <label for="connection_type">Tipo de conex√£o</label>
        <select name="connection_type" id="connection_type">
          <option value="TD2" {% if bucket.get('config', {}).get('connection_type','TD2') == 'TD2' %}selected{% endif %}>TD2</option>
          <option value="LDAP" {% if bucket.get('config', {}).get('connection_type') == 'LDAP' %}selected{% endif %}>LDAP</option>
        </select>
      </div>
      <div>
        <label for="extra_params">Par√¢metros extras</label>
        <input type="text" name="extra_params" id="extra_params" value="{{ bucket.get('config', {}).get('extra_params','') }}" placeholder="ex.: DBS_PORT=1025,CHARSET=UTF8" />
      </div>
    </div>
    <label for="jdbc_url">String JDBC (opcional)</label>
    <input type="text" name="jdbc_url" id="jdbc_url" value="{{ bucket.get('config', {}).get('jdbc_url','') }}" placeholder="jdbc:teradata://host/DATABASE=DBC,LOGMECH=TD2" />
    <p class="form-helper">Se deixar vazio, o JDBC ser√° montado automaticamente com os campos acima.</p>

    <div class="grid-two">
      <div>
        <label for="username">Usu√°rio</label>
        <input type="text" name="username" id="username" value="{{ bucket.get('config', {}).get('username','') }}" />
      </div>
      <div>
        <label for="password">Senha</label>
        <input type="password" name="password" id="password" value="{{ bucket.get('config', {}).get('password','') }}" />
      </div>
    </div>

    <div class="actions-inline">
      <button type="submit" class="button ghost" name="action" value="test"><span class="icon">üß™</span><span>Testar conex√£o</span></button>
      <button type="submit" class="button"><span class="icon">‚û°Ô∏è</span><span>Avan√ßar</span></button>
    </div>
  </form>

  {% elif step == 'tipos' %}
  <div class="wizard">
    <div class="wizard-step done">1. Conex√£o</div>
    <div class="wizard-step active">2. Tipo</div>
    <div class="wizard-step">3. Agenda</div>
    <div class="wizard-step">4. Extra√ß√£o</div>
  </div>
  <form action="{{ url_for('extract_teradata', step='tipos') }}" method="post" class="card">
    <p class="form-helper">Escolha o tipo de execu√ß√£o e o modo. No incremental apenas bases novas ou atualiza√ß√µes s√£o aplicadas; a execu√ß√£o completa limpa as bases vindas do Teradata antes de inserir novamente.</p>
    <div class="grid-two">
      <div class="card inset">
        <label class="radio-tile">
          <input type="radio" name="extraction_type" value="metadata" checked />
          <div>
            <strong>Metadados</strong>
            <p>Busca DatabaseName e CommentString conforme a consulta informada.</p>
          </div>
        </label>
        <label class="radio-tile disabled">
          <input type="radio" disabled />
          <div>
            <strong>Profiling</strong>
            <p>Em breve para estat√≠sticas e qualidade.</p>
          </div>
        </label>
      </div>
      <div class="card inset">
        <label class="radio-tile">
          <input type="radio" name="mode" value="incremental" {% if bucket.get('mode','incremental') == 'incremental' %}checked{% endif %} />
          <div>
            <strong>Incremental</strong>
            <p>Inclui novas bases e atualiza descri√ß√µes j√° importadas.</p>
          </div>
        </label>
        <label class="radio-tile">
          <input type="radio" name="mode" value="full" {% if bucket.get('mode') == 'full' %}checked{% endif %} />
          <div>
            <strong>Completa</strong>
            <p>Remove bases trazidas de extra√ß√µes anteriores do Teradata e reaplica tudo.</p>
          </div>
        </label>
      </div>
    </div>
    <div class="actions-inline">
      <a class="button ghost" href="{{ url_for('extract_teradata') }}"><span class="icon">‚Ü©</span><span>Voltar</span></a>
      <button type="submit" class="button"><span class="icon">‚û°Ô∏è</span><span>Continuar</span></button>
    </div>
  </form>

  {% elif step == 'agenda' %}
  <div class="wizard">
    <div class="wizard-step done">1. Conex√£o</div>
    <div class="wizard-step done">2. Tipo</div>
    <div class="wizard-step active">3. Agenda</div>
    <div class="wizard-step">4. Extra√ß√£o</div>
  </div>
  <form action="{{ url_for('extract_teradata', step='agenda') }}" method="post" class="card">
    <p class="form-helper">Escolha se deseja executar apenas uma vez ou vincular a um schedule existente para reuso em novos jobs.</p>
    <label class="radio-tile">
      <input type="radio" name="execution_plan" value="once" {% if bucket.get('run_once', True) %}checked{% endif %} />
      <div>
        <strong>Execu√ß√£o √∫nica</strong>
        <p>Roda apenas uma vez sem reaproveitar agenda.</p>
      </div>
    </label>

    <div class="card inset">
      <div class="actions-inline">
        <label class="radio-tile">
          <input type="radio" name="execution_plan" value="scheduled" {% if bucket.get('run_once') is sameas false %}checked{% endif %} />
          <div>
            <strong>Usar schedule existente</strong>
            <p>Reaproveite agendas criadas no gerenciador.</p>
          </div>
        </label>
        <a class="button ghost" href="{{ url_for('schedules') }}"><span class="icon">üóìÔ∏è</span><span>Gerenciar schedules</span></a>
      </div>
      <label for="schedule_id">Selecione um schedule</label>
      <select name="schedule_id" id="schedule_id">
        <option value="">Escolha uma agenda</option>
        {% for sched in schedules %}
        <option value="{{ sched.id }}" {% if bucket.get('schedule_id') == sched.id %}selected{% endif %}>
          {{ sched.name }} ¬∑ {{ humanize_days(sched.days_of_week) }} {% if sched.start_time %}- {{ sched.start_time }}{% endif %}
        </option>
        {% endfor %}
      </select>
      {% if schedules|length == 0 %}
      <p class="form-helper">Nenhum schedule criado ainda. Crie um novo para habilitar execu√ß√µes recorrentes.</p>
      {% endif %}
    </div>
    <div class="actions-inline">
      <a class="button ghost" href="{{ url_for('extract_teradata', step='tipos') }}"><span class="icon">‚Ü©</span><span>Voltar</span></a>
      <button type="submit" class="button"><span class="icon">‚û°Ô∏è</span><span>Avan√ßar</span></button>
    </div>
  </form>

  {% elif step == 'executar' %}
  <div class="wizard">
    <div class="wizard-step done">1. Conex√£o</div>
    <div class="wizard-step done">2. Tipo</div>
    <div class="wizard-step done">3. Agenda</div>
    <div class="wizard-step active">4. Extra√ß√£o</div>
  </div>
  <div class="card">
    <div class="grid-two">
      <div>
        <p class="eyebrow">Resumo</p>
        <ul class="summary-list">
          <li><strong>JDBC:</strong> {{ bucket.get('config', {}).get('jdbc_url') or 'Gerado automaticamente' }}</li>
          <li><strong>Tipo:</strong> {{ bucket.get('extraction_type','metadata') }}</li>
          <li><strong>Modo:</strong> {{ bucket.get('mode','incremental') }}</li>
          {% if selected_schedule %}
          <li><strong>Agenda:</strong> {{ selected_schedule['name'] }} ¬∑ {{ humanize_days(selected_schedule['days_of_week']) }}{% if selected_schedule['start_time'] %} √†s {{ selected_schedule['start_time'] }}{% endif %}</li>
          {% else %}
          <li><strong>Agenda:</strong> Execu√ß√£o √∫nica</li>
          {% endif %}
        </ul>
      </div>
      <div>
        <p class="eyebrow">Gestor padr√£o</p>
        <p class="subtitle">As bases extra√≠das s√£o atribu√≠das ao gestor padr√£o de metadados para manter o v√≠nculo obrigat√≥rio.</p>
      </div>
    </div>
    <form action="{{ url_for('extract_teradata', step='executar') }}" method="post" class="actions-inline">
      <button type="submit" class="button"><span class="icon">üöÄ</span><span>Iniciar extra√ß√£o</span></button>
      <a class="button ghost" href="{{ url_for('extraction_menu') }}"><span class="icon">üèÅ</span><span>Voltar</span></a>
    </form>

    {% if bucket.get('result') %}
    {% set result = bucket.get('result') %}
    <div class="progress">
      <div class="progress-bar" style="width: {{ result.total and 100 or 0 }}%"></div>
    </div>
    <div class="stats">
      <div class="stat"><strong>{{ result.imported }}</strong><span>Aplicadas</span></div>
      <div class="stat"><strong>{{ result.total }}</strong><span>Recebidas</span></div>
    </div>
    {% if result.note %}
    <div class="alert info">{{ result.note }}</div>
    {% endif %}
    {% if result.errors and result.errors|length %}
    <div class="alert error">
      <p>Ocorreram avisos:</p>
      <ul>
        {% for err in result.errors %}<li>{{ err }}</li>{% endfor %}
      </ul>
    </div>
    {% else %}
    <div class="alert success">Extra√ß√£o conclu√≠da.</div>
    {% endif %}
    <div class="actions-inline">
      <a class="button" href="{{ url_for('monitor_jobs') }}"><span class="icon">üìä</span><span>Acompanhar jobs</span></a>
      <a class="button ghost" href="{{ url_for('extract_teradata') }}"><span class="icon">üîÅ</span><span>Novo fluxo</span></a>
    </div>
    {% endif %}
  </div>
  {% endif %}
</section>
{% endblock %}

{% extends "base.html" %}
{% block title %}Relat√≥rios | Gest√£o de Bases{% endblock %}
{% block content %}
<section class="section-header">
  <p class="eyebrow">Relat√≥rios</p>
  <div class="section-heading">
    <div>
      <h2>Vis√£o consolidada das bases</h2>
      <p class="muted">Acompanhe cobertura de gestores, distribui√ß√£o por coordena√ß√£o e ambientes em tempo real.</p>
    </div>
    <div class="stat-actions">
      <div class="stat-chips">
        <div class="chip primary">
          <span class="icon">üìä</span>
          <div>
            <p class="eyebrow">Bases registradas</p>
            <strong>{{ total_bases }}</strong>
          </div>
        </div>
        <div class="chip primary">
          <span class="icon">üë•</span>
          <div>
            <p class="eyebrow">Gestores cadastrados</p>
            <strong>{{ total_gestors }}</strong>
          </div>
        </div>
      </div>
      <div class="layout-toggle">
        <button id="toggleLayout" class="ghost" type="button" aria-pressed="false" aria-label="Alternar empilhamento de gr√°ficos">
          <span class="icon">üìê</span> <span class="toggle-label">Empilhar gr√°ficos</span>
        </button>
      </div>
    </div>
  </div>
</section>

<section class="reports-grid" id="reportsGrid" aria-label="√Årea para reordenar gr√°ficos">
  <div class="card chart-card draggable-card" data-card-id="coverage" draggable="true" aria-grabbed="false">
    <div class="card-header">
      <div>
        <p class="eyebrow">Cobertura</p>
        <h3>Bases por gestor</h3>
      </div>
      <div class="card-actions">
        <button type="button" class="ghost drag-handle" aria-label="Arraste para reposicionar" title="Arraste para reposicionar">
          ‚áÖ
        </button>
      </div>
    </div>
    <div class="chart-wrapper">
      <canvas id="coverageChart" aria-label="Gr√°fico de bases por gestor"></canvas>
    </div>
  </div>

  <div class="card chart-card draggable-card" data-card-id="coord" draggable="true" aria-grabbed="false">
    <div class="card-header">
      <div>
        <p class="eyebrow">Panorama</p>
        <h3>Bases por coordena√ß√£o</h3>
      </div>
      <div class="card-actions">
        <button type="button" class="ghost drag-handle" aria-label="Arraste para reposicionar" title="Arraste para reposicionar">
          ‚áÖ
        </button>
      </div>
    </div>
    <div class="chart-wrapper">
      <canvas id="coordChart" aria-label="Gr√°fico de bases por coordena√ß√£o"></canvas>
    </div>
  </div>

  <div class="card chart-card draggable-card" data-card-id="env" draggable="true" aria-grabbed="false">
    <div class="card-header">
      <div>
        <p class="eyebrow">Ambientes</p>
        <h3>Bases por ambiente</h3>
      </div>
      <div class="card-actions">
        <button type="button" class="ghost drag-handle" aria-label="Arraste para reposicionar" title="Arraste para reposicionar">
          ‚áÖ
        </button>
      </div>
    </div>
    <div class="chart-wrapper">
      <canvas id="envChart" aria-label="Gr√°fico de bases por ambiente"></canvas>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const coverageLabels = {{ coverage_labels|tojson }};
  const coverageValues = {{ coverage_values|tojson }};
  const coordLabels = {{ coord_labels|tojson }};
  const coordValues = {{ coord_values|tojson }};
  const envLabels = {{ env_labels|tojson }};
  const envValues = {{ env_values|tojson }};

  const palette = ["#0f6fed", "#7cc4ff", "#36a3f7", "#9dd5ff", "#1d9bf0", "#74a9f2", "#b7d8ff", "#5090ea"];
  const muted = "#cbd5e1";

  const renderChart = (ctxId, config) => {
    const ctx = document.getElementById(ctxId);
    if (!ctx) return;
    return new Chart(ctx, config);
  };

  const grid = document.getElementById("reportsGrid");
  const orderKey = "reports-card-order";
  const layoutKey = "reports-layout-mode";

  const saveOrder = () => {
    if (!grid) return;
    const order = Array.from(grid.querySelectorAll(".draggable-card")).map((card) => card.dataset.cardId);
    localStorage.setItem(orderKey, JSON.stringify(order));
  };

  const applySavedOrder = () => {
    if (!grid) return;
    try {
      const saved = JSON.parse(localStorage.getItem(orderKey) || "[]");
      saved.forEach((id) => {
        const card = grid.querySelector(`[data-card-id="${id}"]`);
        if (card) {
          grid.appendChild(card);
        }
      });
    } catch (err) {
      console.warn("N√£o foi poss√≠vel aplicar a ordem salva", err);
    }
  };

  const applyLayout = () => {
    if (!grid) return;
    const toggle = document.getElementById("toggleLayout");
    const mode = localStorage.getItem(layoutKey) || "grid";
    const stacked = mode === "stacked";
    grid.classList.toggle("stacked", stacked);
    if (toggle) {
      toggle.setAttribute("aria-pressed", stacked ? "true" : "false");
      const labelEl = toggle.querySelector(".toggle-label");
      const iconEl = toggle.querySelector(".icon");
      if (labelEl) labelEl.textContent = stacked ? "Modo lado a lado" : "Empilhar gr√°ficos";
      if (iconEl) iconEl.textContent = stacked ? "üß©" : "üìê";
    }
  };

  const setupLayoutToggle = () => {
    const toggle = document.getElementById("toggleLayout");
    if (!toggle) return;
    toggle.addEventListener("click", () => {
      const stacked = grid.classList.toggle("stacked");
      localStorage.setItem(layoutKey, stacked ? "stacked" : "grid");
      toggle.setAttribute("aria-pressed", stacked ? "true" : "false");
      const labelEl = toggle.querySelector(".toggle-label");
      const iconEl = toggle.querySelector(".icon");
      if (labelEl) labelEl.textContent = stacked ? "Modo lado a lado" : "Empilhar gr√°ficos";
      if (iconEl) iconEl.textContent = stacked ? "üß©" : "üìê";
    });
  };

  const setupDragAndDrop = () => {
    if (!grid) return;
    const cards = Array.from(grid.querySelectorAll(".draggable-card"));

    cards.forEach((card) => {
      card.addEventListener("dragstart", (e) => {
        card.classList.add("dragging");
        card.setAttribute("aria-grabbed", "true");
        e.dataTransfer.setData("text/plain", card.dataset.cardId);
        e.dataTransfer.effectAllowed = "move";
      });

      card.addEventListener("dragend", () => {
        card.classList.remove("dragging");
        card.setAttribute("aria-grabbed", "false");
        grid.querySelectorAll(".drag-over").forEach((el) => el.classList.remove("drag-over"));
        saveOrder();
      });

      card.addEventListener("dragover", (e) => {
        e.preventDefault();
      });

      card.addEventListener("dragenter", (e) => {
        e.preventDefault();
        if (!card.classList.contains("dragging")) {
          card.classList.add("drag-over");
        }
      });

      card.addEventListener("dragleave", () => {
        card.classList.remove("drag-over");
      });

      card.addEventListener("drop", (e) => {
        e.preventDefault();
        const sourceId = e.dataTransfer.getData("text/plain");
        const sourceCard = grid.querySelector(`[data-card-id="${sourceId}"]`);
        card.classList.remove("drag-over");
        if (!sourceCard || sourceCard === card) return;

        const children = Array.from(grid.children);
        const targetIndex = children.indexOf(card);
        const sourceIndex = children.indexOf(sourceCard);

        if (sourceIndex < targetIndex) {
          grid.insertBefore(sourceCard, card.nextSibling);
        } else {
          grid.insertBefore(sourceCard, card);
        }

        saveOrder();
      });
    });
  };

  renderChart("coverageChart", {
    type: "doughnut",
    data: {
      labels: coverageLabels,
      datasets: [
        {
          data: coverageValues,
          backgroundColor: coverageLabels.map((_, idx) => palette[idx % palette.length]),
          borderWidth: 0,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: "bottom",
          labels: { usePointStyle: true },
        },
      },
      cutout: "60%",
    },
  });

  renderChart("coordChart", {
    type: "bar",
    data: {
      labels: coordLabels,
      datasets: [
        {
          label: "Bases",
          data: coordValues,
          backgroundColor: coordLabels.map((_, idx) => palette[idx % palette.length]),
          borderRadius: 10,
        },
      ],
    },
    options: {
      scales: {
        x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } },
        y: { beginAtZero: true, precision: 0 },
      },
      plugins: { legend: { display: false } },
    },
  });

  renderChart("envChart", {
    type: "bar",
    data: {
      labels: envLabels,
      datasets: [
        {
          label: "Bases",
          data: envValues,
          backgroundColor: envLabels.map((_, idx) => palette[(idx + 2) % palette.length]),
          borderRadius: 10,
        },
      ],
    },
    options: {
      scales: {
        x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } },
        y: { beginAtZero: true, precision: 0 },
      },
      plugins: { legend: { display: false } },
    },
  });

  applySavedOrder();
  applyLayout();
  setupDragAndDrop();
  setupLayoutToggle();
</script>
{% endblock %}

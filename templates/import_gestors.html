{% extends "base.html" %}
{% block title %}Importar gestores{% endblock %}
{% block content %}
<section class="form-section">
  <div class="section-header">
    <div>
      <p class="eyebrow">Importa√ß√£o guiada</p>
      <h2>Importar gestores</h2>
      <p class="subtitle">Fluxo em tr√™s etapas para selecionar o arquivo, mapear as colunas e acompanhar a importa√ß√£o.</p>
    </div>
    <div class="pill">Gestores</div>
  </div>

  {% if step == 'upload' %}
  <div class="wizard">
    <div class="wizard-step active">1. Arquivo</div>
    <div class="wizard-step">2. Mapeamento</div>
    <div class="wizard-step">3. Importa√ß√£o</div>
  </div>
  <form action="{{ url_for('import_gestors_flow', step='upload') }}" method="post" enctype="multipart/form-data" class="card">
    <label for="file">Arquivo (CSV ou XLSX)</label>
    <input type="file" name="file" id="file" accept=".csv,.xlsx,.xls" required />

    <label for="delimiter">Delimitador (para CSV)</label>
    <input type="text" name="delimiter" id="delimiter" value=";" maxlength="3" />
    <p class="form-helper">Usado apenas em CSV. Para XLSX √© ignorado.</p>

    <div class="actions-inline">
      <a class="button ghost" href="{{ url_for('download_gestor_template') }}"><span class="icon">üì•</span><span>Baixar modelo XLSX</span></a>
      <button type="submit" class="button"><span class="icon">‚¨ÜÔ∏è</span><span>Continuar</span></button>
      <a class="button ghost" href="{{ url_for('import_records') }}"><span class="icon">‚Ü©</span><span>Voltar</span></a>
    </div>
  </form>
  {% elif step == 'mapear' %}
  <div class="wizard">
    <div class="wizard-step done">1. Arquivo</div>
    <div class="wizard-step active">2. Mapeamento</div>
    <div class="wizard-step">3. Importa√ß√£o</div>
  </div>
  <form action="{{ url_for('import_gestors_flow', step='mapear') }}" method="post" class="card">
    <p class="form-helper">Escolha de qual coluna do arquivo vir√° cada informa√ß√£o do gestor.</p>
    <div class="grid-two">
      <div>
        <label for="map_name">Nome do gestor</label>
        <select name="map_name" id="map_name" required>
          <option value="">Selecione</option>
          {% for col in headers %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
        </select>
      </div>
      <div>
        <label for="map_email">E-mail</label>
        <select name="map_email" id="map_email" required>
          <option value="">Selecione</option>
          {% for col in headers %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
        </select>
      </div>
      <div>
        <label for="map_secretaria">Secretaria</label>
        <select name="map_secretaria" id="map_secretaria" required>
          <option value="">Selecione</option>
          {% for col in headers %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
        </select>
      </div>
      <div>
        <label for="map_coordenacao">Coordena√ß√£o</label>
        <select name="map_coordenacao" id="map_coordenacao" required>
          <option value="">Selecione</option>
          {% for col in headers %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
        </select>
      </div>
    </div>

    <div class="table-scroll">
      <table>
        <thead>
          <tr>{% for col in headers %}<th>{{ col }}</th>{% endfor %}</tr>
        </thead>
        <tbody>
          {% for row in preview %}
          <tr>{% for col in headers %}<td>{{ row.get(col, '') }}</td>{% endfor %}</tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="actions-inline">
      <a class="button ghost" href="{{ url_for('import_gestors_flow') }}"><span class="icon">‚Ü©</span><span>Voltar</span></a>
      <button type="submit" class="button"><span class="icon">‚û°Ô∏è</span><span>Avan√ßar</span></button>
    </div>
  </form>
  {% elif step == 'confirmar' %}
  <div class="wizard">
    <div class="wizard-step done">1. Arquivo</div>
    <div class="wizard-step done">2. Mapeamento</div>
    <div class="wizard-step active">3. Importa√ß√£o</div>
  </div>
  <div class="card">
    <p class="subtitle">Revise os campos que ser√£o importados. Apenas linhas completas ser√£o processadas.</p>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Secretaria</th>
            <th>Coordena√ß√£o</th>
            <th>E-mail</th>
          </tr>
        </thead>
        <tbody>
          {% for row in preview %}
          <tr>
            <td>{{ row.name }}</td>
            <td>{{ row.secretaria }}</td>
            <td>{{ row.coordenacao }}</td>
            <td>{{ row.email }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <p class="form-helper">Total de linhas encontradas: {{ total }}. Linhas sem campos obrigat√≥rios ser√£o ignoradas.</p>
    <form action="{{ url_for('import_gestors_flow', step='executar') }}" method="post" class="actions-inline">
      <a class="button ghost" href="{{ url_for('import_gestors_flow', step='mapear') }}"><span class="icon">‚Ü©</span><span>Voltar</span></a>
      <button type="submit" class="button"><span class="icon">üöÄ</span><span>Iniciar importa√ß√£o</span></button>
    </form>
  </div>
  {% elif step == 'resultado' %}
  <div class="wizard">
    <div class="wizard-step done">1. Arquivo</div>
    <div class="wizard-step done">2. Mapeamento</div>
    <div class="wizard-step done">3. Importa√ß√£o</div>
  </div>
  <div class="card">
    <p class="subtitle">Acompanhe o progresso da importa√ß√£o.</p>
    <div class="progress">
      <div class="progress-bar" style="width: {{ result.progress }}%"></div>
    </div>
    <div class="stats">
      <div class="stat"><strong>{{ result.imported }}</strong><span>Importados</span></div>
      <div class="stat"><strong>{{ result.total }}</strong><span>Total</span></div>
    </div>
    {% if result.errors and result.errors|length %}
    <div class="alert error">
      <p>Ocorreram avisos durante o processo:</p>
      <ul>
        {% for err in result.errors %}
        <li>{{ err }}</li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
    <div class="alert success">Importa√ß√£o finalizada sem erros.</div>
    {% endif %}
    <div class="actions-inline">
      <a class="button ghost" href="{{ url_for('import_gestors_flow') }}"><span class="icon">üîÅ</span><span>Importar novamente</span></a>
      <a class="button" href="{{ url_for('list_gestors') }}"><span class="icon">üìÑ</span><span>Ver gestores</span></a>
    </div>
  </div>
  {% endif %}
</section>
{% endblock %}

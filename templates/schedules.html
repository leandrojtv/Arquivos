{% extends "base.html" %}
{% block title %}Schedules{% endblock %}
{% block content %}
<section class="form-section">
  <div class="section-header with-action">
    <div>
      <p class="eyebrow">Orquestra√ß√£o</p>
      <h2>Schedules</h2>
      <p class="subtitle">Cadastre agendas reutiliz√°veis para execu√ß√µes autom√°ticas.</p>
    </div>
    <div class="actions-inline">
      <button type="button" class="button primary open-schedule" data-mode="create"><span class="icon">‚ûï</span><span>Novo schedule</span></button>
    </div>
  </div>

  <div class="card">
    <div class="card-header between">
      <div>
        <p class="eyebrow">Agendas</p>
        <h3>Schedules salvos</h3>
      </div>
      <div class="pill">{{ schedules|length }} ativos</div>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Dias</th>
            <th>Hora</th>
            <th>Intervalo</th>
            <th>Repeti√ß√£o</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for sched in schedules %}
          <tr>
            <td>{{ sched.name }}</td>
            <td>{{ sched.days_label }}</td>
            <td>{{ sched.start_time or '‚Äî' }}</td>
            <td>{{ sched.interval or '‚Äî' }} {% if sched.interval %}min{% endif %}</td>
            <td>{{ 'Indefinido' if sched.repeat_forever else 'At√© finalizar' }}</td>
            <td class="actions-inline">
              <button type="button" class="button ghost open-schedule" data-mode="edit"
                data-id="{{ sched.id }}"
                data-name="{{ sched.name }}"
                data-start-date="{{ sched.start_date or '' }}"
                data-start-time="{{ sched.start_time or '' }}"
                data-days-raw="{{ sched.days_of_week or '' }}"
                data-interval="{{ sched.interval or '' }}"
                data-repeat="{{ 1 if sched.repeat_forever else 0 }}">
                <span class="icon">‚úèÔ∏è</span><span>Editar</span>
              </button>
              <form action="{{ url_for('delete_schedule', schedule_id=sched.id) }}" method="post" style="display:inline">
                <button type="submit" class="button ghost"><span class="icon">üóëÔ∏è</span><span>Excluir</span></button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="6">Nenhum schedule criado ainda.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<div class="modal-overlay {% if edit_schedule %}open{% endif %}" id="schedule-modal" aria-hidden="{{ 'false' if edit_schedule else 'true' }}">
  <div class="modal-card wide" role="dialog" aria-modal="true" aria-labelledby="schedule-title">
    <header class="modal-header">
      <div>
        <p class="eyebrow">Schedule</p>
        <h3 id="schedule-title">{{ 'Editar schedule' if edit_schedule else 'Novo schedule' }}</h3>
        <p class="subtitle">Defina quando e com que frequ√™ncia os jobs devem rodar.</p>
      </div>
      <button type="button" class="icon-button close-modal" data-target="schedule-modal" aria-label="Fechar"><span class="icon">‚úï</span></button>
    </header>
    <form id="schedule-form" action="{{ url_for('schedules') }}" method="post" class="form-grid">
      <input type="hidden" name="schedule_id" id="schedule_id" value="{{ edit_schedule and edit_schedule['id'] or '' }}" />
      <div class="grid-two">
        <div>
          <label for="name">Nome</label>
          <input type="text" name="name" id="name" placeholder="Agendamento di√°rio" value="{{ edit_schedule and edit_schedule['name'] or '' }}" required />
        </div>
        <div class="grid-two compact">
          <div>
            <label for="start_date">Data inicial</label>
            <input type="date" name="start_date" id="start_date" value="{{ edit_schedule and edit_schedule['start_date'] or '' }}" />
          </div>
          <div>
            <label for="start_time">Hora</label>
            <input type="time" name="start_time" id="start_time" value="{{ edit_schedule and edit_schedule['start_time'] or '' }}" />
          </div>
        </div>
      </div>

      <div>
        <p class="eyebrow">Dias da semana</p>
        <div class="chips">
          {% set chosen = (edit_schedule and (edit_schedule['days_of_week'] or '') or '').split(',') %}
          {% for code, label in days_options %}
          <label class="chip-checkbox">
            <input type="checkbox" name="days_of_week" value="{{ code }}" {% if code in chosen %}checked{% endif %} />
            <span>{{ label }}</span>
          </label>
          {% endfor %}
        </div>
      </div>

      <div class="grid-two">
        <div>
          <label for="interval_minutes">Intervalo (minutos)</label>
          <input type="number" name="interval_minutes" id="interval_minutes" min="0" step="5" placeholder="60" value="{{ edit_schedule and edit_schedule['interval_minutes'] or '' }}" />
        </div>
        <div class="align-end">
          <label class="checkbox">
            <input type="checkbox" name="repeat_forever" id="repeat_forever" {% if edit_schedule and edit_schedule['repeat_forever'] %}checked{% endif %} />
            <span>Repetir indefinidamente</span>
          </label>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="button ghost close-modal" data-target="schedule-modal"><span class="icon">‚Ü©</span><span>Cancelar</span></button>
        <button type="submit" class="button"><span class="icon">üíæ</span><span id="schedule-submit-label">{{ 'Salvar altera√ß√µes' if edit_schedule else 'Criar schedule' }}</span></button>
      </div>
    </form>
  </div>
</div>
<script>
  const scheduleModal = document.getElementById('schedule-modal');
  const scheduleForm = document.getElementById('schedule-form');
  const scheduleTitle = document.getElementById('schedule-title');
  const submitLabel = document.getElementById('schedule-submit-label');

  const clearScheduleForm = () => {
    if (!scheduleForm) return;
    scheduleForm.reset();
    scheduleForm.querySelector('#schedule_id').value = '';
    scheduleTitle.textContent = 'Novo schedule';
    submitLabel.textContent = 'Criar schedule';
  };

  const setDays = (raw) => {
    const allowed = (raw || '').split(',').map((d) => d.trim()).filter(Boolean);
    scheduleForm?.querySelectorAll('input[name="days_of_week"]').forEach((input) => {
      input.checked = allowed.includes(input.value);
    });
  };

  const fillScheduleForm = (data) => {
    if (!scheduleForm) return;
    scheduleForm.querySelector('#name').value = data.name || '';
    scheduleForm.querySelector('#start_date').value = data.startDate || '';
    scheduleForm.querySelector('#start_time').value = data.startTime || '';
    scheduleForm.querySelector('#interval_minutes').value = data.interval || '';
    scheduleForm.querySelector('#schedule_id').value = data.id || '';
    const repeatEl = scheduleForm.querySelector('#repeat_forever');
    if (repeatEl) repeatEl.checked = data.repeat === '1' || data.repeat === 1 || data.repeat === true;
    setDays(data.daysRaw || '');
    scheduleTitle.textContent = data.id ? 'Editar schedule' : 'Novo schedule';
    submitLabel.textContent = data.id ? 'Salvar altera√ß√µes' : 'Criar schedule';
  };

  document.querySelectorAll('.open-schedule').forEach((btn) => {
    btn.addEventListener('click', () => {
      const mode = btn.dataset.mode;
      if (mode === 'edit') {
        fillScheduleForm({
          id: btn.dataset.id,
          name: btn.dataset.name,
          startDate: btn.dataset.startDate,
          startTime: btn.dataset.startTime,
          interval: btn.dataset.interval,
          repeat: btn.dataset.repeat,
          daysRaw: btn.dataset.daysRaw,
        });
      } else {
        clearScheduleForm();
      }
      if (typeof toggleModal === 'function') {
        toggleModal('schedule-modal', true);
      }
    });
  });

  {% if edit_schedule %}
  fillScheduleForm({
    id: '{{ edit_schedule['id'] }}',
    name: '{{ edit_schedule['name']|escape }}',
    startDate: '{{ edit_schedule['start_date'] or '' }}',
    startTime: '{{ edit_schedule['start_time'] or '' }}',
    interval: '{{ edit_schedule['interval_minutes'] or '' }}',
    repeat: '{{ 1 if edit_schedule['repeat_forever'] else 0 }}',
    daysRaw: '{{ edit_schedule['days_of_week'] or '' }}',
  });
  {% endif %}
</script>
{% endblock %}

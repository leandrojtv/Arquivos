<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}GestÃ£o de Bases e Gestores{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <header class="site-header">
      <div class="header-main">
        {% if session.get('user') %}
        <button class="menu-toggle" type="button" aria-expanded="false" aria-controls="main-menu">
          <span class="icon">â˜°</span>
          <span>Menu</span>
        </button>
        {% endif %}
        <div>
          <h1>Cadastro de Bases e Gestores</h1>
          <p class="subtitle">Registre responsÃ¡veis, ambientes e detalhes das bases.</p>
        </div>
        {% if session.get('user') %}
        <div class="user-menu" tabindex="0">
          <div class="user-trigger">
            <div class="avatar">{{ session.get('user')[0]|upper }}</div>
            <span class="user-name">{{ session.get('user') }}</span>
            <span class="chevron">â–¾</span>
          </div>
          <div class="user-dropdown">
            <a href="{{ url_for('settings') }}">ConfiguraÃ§Ãµes</a>
            <a href="{{ url_for('monitor_jobs') }}">Jobs de extraÃ§Ã£o</a>
            <a href="{{ url_for('logout') }}">Sair</a>
          </div>
        </div>
        {% endif %}
      </div>
      <nav class="main-nav" id="main-menu">
        {% if session.get('user') %}
        <button type="button" class="button nav-button primary open-modal nav-new" data-target="novo-modal">
          <span class="icon">âœš</span><span>Novo</span>
        </button>
        <div class="nav-links">
          <a class="button nav-button ghost" href="{{ url_for('landing') }}"><span class="icon">ğŸ </span><span>InÃ­cio</span></a>
          <a class="button nav-button ghost" href="{{ url_for('list_bases') }}"><span class="icon">ğŸ—‚ï¸</span><span>Bases</span></a>
          <a class="button nav-button ghost" href="{{ url_for('list_gestors') }}"><span class="icon">ğŸ‘¥</span><span>Gestores</span></a>
          <a class="button nav-button ghost" href="{{ url_for('search') }}"><span class="icon">ğŸ”</span><span>Pesquisar</span></a>
          <a class="button nav-button ghost" href="{{ url_for('import_records') }}"><span class="icon">â¬†ï¸</span><span>Importar</span></a>
          <a class="button nav-button ghost" href="{{ url_for('extraction_menu') }}"><span class="icon">ğŸ›°ï¸</span><span>ExtraÃ§Ã£o</span></a>
        </div>
        {% else %}
        <a href="{{ url_for('login') }}" class="pill">Login</a>
        {% endif %}
      </nav>
    </header>
    {% if session.get('user') %}
    <div class="modal-overlay" id="novo-modal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="novo-title">
        <header class="modal-header">
          <div>
            <p class="eyebrow">Novo</p>
            <h3 id="novo-title">O que deseja cadastrar?</h3>
            <p class="subtitle">Escolha se quer criar um gestor ou uma base.</p>
          </div>
          <button type="button" class="icon-button close-modal" data-target="novo-modal" aria-label="Fechar"><span class="icon">âœ•</span></button>
        </header>
        <div class="modal-actions">
          <a class="button" href="{{ url_for('new_gestor_form') }}"><span class="icon">ğŸ‘¤</span><span>Novo gestor</span></a>
          <a class="button secondary" href="{{ url_for('new_base_form') }}"><span class="icon">ğŸ—‚ï¸</span><span>Nova base</span></a>
        </div>
        <button type="button" class="button ghost full close-modal" data-target="novo-modal"><span class="icon">â†©</span><span>Cancelar</span></button>
      </div>
    </div>
    {% endif %}
    <main>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul class="messages">
            {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
    {% if session.get('user') %}
    <script>
      const toggleModal = (targetId, open) => {
        const el = document.getElementById(targetId);
        if (!el) return;
        if (open) {
          el.classList.add('open');
          el.setAttribute('aria-hidden', 'false');
        } else {
          el.classList.remove('open');
          el.setAttribute('aria-hidden', 'true');
        }
      };
      document.addEventListener('click', (event) => {
        const openTrigger = event.target.closest('.open-modal');
        if (openTrigger) {
          toggleModal(openTrigger.dataset.target, true);
        }
        const closeTrigger = event.target.closest('.close-modal');
        if (closeTrigger) {
          toggleModal(closeTrigger.dataset.target, false);
        }
        const overlay = event.target.classList.contains('modal-overlay') ? event.target : null;
        if (overlay) {
          toggleModal(overlay.id, false);
        }

        const menuToggle = document.querySelector('.menu-toggle');
        const mainNav = document.getElementById('main-menu');
        if (menuToggle && mainNav && !mainNav.contains(event.target) && !menuToggle.contains(event.target)) {
          mainNav.classList.remove('open');
          menuToggle.setAttribute('aria-expanded', 'false');
        }
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          document.querySelectorAll('.modal-overlay.open').forEach((el) => toggleModal(el.id, false));
        }
      });
      const menuToggle = document.querySelector('.menu-toggle');
      const mainNav = document.getElementById('main-menu');
      if (menuToggle && mainNav) {
        if (window.innerWidth > 900) {
          mainNav.classList.add('open');
          menuToggle.setAttribute('aria-expanded', 'true');
        }
        menuToggle.addEventListener('click', () => {
          const isOpen = mainNav.classList.toggle('open');
          menuToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });
      }
    </script>
    {% endif %}
  </body>
</html>

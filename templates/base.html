<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}GestÃ£o de Bases e Gestores{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body class="app-shell">
    <div class="dashboard-shell {% if session.get('user') %}has-sidebar{% endif %}">
      {% if session.get('user') %}
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="brand">
            <div class="brand-icon">DB</div>
            <div>
              <p class="eyebrow">Console</p>
              <h2>GestÃ£o</h2>
            </div>
          </div>
          <button class="icon-button ghost close-sidebar" type="button" aria-label="Fechar menu" data-target="sidebar">âœ•</button>
        </div>
        <div class="sidebar-actions">
          <button type="button" class="button nav-button primary open-modal nav-new" data-target="novo-modal">
            <span class="icon">âœš</span><span>Novo</span>
          </button>
        </div>
        <nav class="main-nav open" id="main-menu">
          <a class="button nav-button ghost" href="{{ url_for('landing') }}"><span class="icon">ğŸ </span><span>InÃ­cio</span></a>
          <a class="button nav-button ghost" href="{{ url_for('list_bases') }}"><span class="icon">ğŸ—‚ï¸</span><span>Bases</span></a>
          <a class="button nav-button ghost" href="{{ url_for('list_gestors') }}"><span class="icon">ğŸ‘¥</span><span>Gestores</span></a>
          <a class="button nav-button ghost" href="{{ url_for('search') }}"><span class="icon">ğŸ”</span><span>Pesquisar</span></a>
          <a class="button nav-button ghost" href="{{ url_for('import_records') }}"><span class="icon">â¬†ï¸</span><span>Importar</span></a>
          <a class="button nav-button ghost" href="{{ url_for('reports') }}"><span class="icon">ğŸ“ˆ</span><span>RelatÃ³rios</span></a>
          <a class="button nav-button ghost" href="{{ url_for('extraction_menu') }}"><span class="icon">ğŸ›°ï¸</span><span>ExtraÃ§Ã£o</span></a>
        </nav>
        <div class="sidebar-footer">
          <p class="muted">Layout inspirado no template Vue.js admin da Cruip.</p>
        </div>
      </aside>
      {% endif %}

      <div class="workspace">
        <header class="site-header">
          <div class="header-main">
            {% if session.get('user') %}
            <button class="menu-toggle ghost" type="button" aria-expanded="false" aria-controls="sidebar">
              <span class="icon">â˜°</span>
            </button>
            {% endif %}
            <div>
              <p class="eyebrow">Painel</p>
              <h1>Cadastro de Bases e Gestores</h1>
              <p class="subtitle">Registre responsÃ¡veis, ambientes e detalhes das bases.</p>
            </div>
            {% if session.get('user') %}
            <div class="user-menu" tabindex="0">
              <div class="user-trigger">
                <div class="avatar">{{ session.get('user')[0]|upper }}</div>
                <span class="user-name">{{ session.get('user') }}</span>
                <span class="chevron">â–¾</span>
              </div>
              <div class="user-dropdown">
                <a href="{{ url_for('settings') }}">ConfiguraÃ§Ãµes</a>
                <a href="{{ url_for('monitor_jobs') }}">Jobs de extraÃ§Ã£o</a>
                <a href="{{ url_for('logout') }}">Sair</a>
              </div>
            </div>
            {% else %}
            <a href="{{ url_for('login') }}" class="pill">Login</a>
            {% endif %}
          </div>
        </header>
    {% if session.get('user') %}
    <div class="modal-overlay" id="novo-modal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="novo-title">
        <header class="modal-header">
          <div>
            <p class="eyebrow">Novo</p>
            <h3 id="novo-title">O que deseja cadastrar?</h3>
            <p class="subtitle">Escolha se quer criar um gestor ou uma base.</p>
          </div>
          <button type="button" class="icon-button close-modal" data-target="novo-modal" aria-label="Fechar"><span class="icon">âœ•</span></button>
        </header>
        <div class="modal-actions">
          <a class="button" href="{{ url_for('new_gestor_form') }}"><span class="icon">ğŸ‘¤</span><span>Novo gestor</span></a>
          <a class="button secondary" href="{{ url_for('new_base_form') }}"><span class="icon">ğŸ—‚ï¸</span><span>Nova base</span></a>
        </div>
        <button type="button" class="button ghost full close-modal" data-target="novo-modal"><span class="icon">â†©</span><span>Cancelar</span></button>
      </div>
    </div>
    {% endif %}
    <main>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul class="messages">
            {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
      </div>
    </div>
    {% if session.get('user') %}
    <script>
      const toggleModal = (targetId, open) => {
        const el = document.getElementById(targetId);
        if (!el) return;
        if (open) {
          el.classList.add('open');
          el.setAttribute('aria-hidden', 'false');
        } else {
          el.classList.remove('open');
          el.setAttribute('aria-hidden', 'true');
        }
      };
      document.addEventListener('click', (event) => {
        const openTrigger = event.target.closest('.open-modal');
        if (openTrigger) {
          toggleModal(openTrigger.dataset.target, true);
        }
        const closeTrigger = event.target.closest('.close-modal');
        if (closeTrigger) {
          toggleModal(closeTrigger.dataset.target, false);
        }
        const overlay = event.target.classList.contains('modal-overlay') ? event.target : null;
        if (overlay) {
          toggleModal(overlay.id, false);
        }

        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.querySelector('.menu-toggle');
        if (sidebar && menuToggle && !sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
          sidebar.classList.remove('open');
          shell?.classList.remove('sidebar-open');
          menuToggle.setAttribute('aria-expanded', 'false');
        }
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          document.querySelectorAll('.modal-overlay.open').forEach((el) => toggleModal(el.id, false));
          const sidebar = document.getElementById('sidebar');
          const toggle = document.querySelector('.menu-toggle');
          if (sidebar && toggle) {
            sidebar.classList.remove('open');
            shell?.classList.remove('sidebar-open');
            toggle.setAttribute('aria-expanded', 'false');
          }
        }
      });
      const menuToggle = document.querySelector('.menu-toggle');
      const sidebar = document.getElementById('sidebar');
      const shell = document.querySelector('.dashboard-shell');
      if (menuToggle && sidebar) {
        if (window.innerWidth > 1024) {
          sidebar.classList.add('open');
          shell?.classList.add('sidebar-open');
          menuToggle.setAttribute('aria-expanded', 'true');
        }
        menuToggle.addEventListener('click', () => {
          const isOpen = sidebar.classList.toggle('open');
          if (shell) {
            shell.classList.toggle('sidebar-open', isOpen);
          }
          menuToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });
      }
      document.querySelectorAll('.close-sidebar').forEach((btn) => {
        btn.addEventListener('click', () => {
          const target = document.getElementById(btn.dataset.target);
          if (target) target.classList.remove('open');
          shell?.classList.remove('sidebar-open');
        });
      });
    </script>
    {% endif %}
  </body>
</html>
